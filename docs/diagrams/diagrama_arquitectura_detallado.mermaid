graph TB
  classDef presentation fill:#dbeafe,stroke:#1e40af,color:#1e3a8a,stroke-width:2px
  classDef business fill:#dcfce7,stroke:#16a34a,color:#14532d,stroke-width:2px
  classDef data fill:#fef3c7,stroke:#d97706,color:#78350f,stroke-width:2px
  classDef integration fill:#e9d5ff,stroke:#9333ea,color:#581c87,stroke-width:2px
  classDef storage fill:#fecaca,stroke:#dc2626,color:#7f1d1d,stroke-width:2px
  classDef config fill:#f3f4f6,stroke:#6b7280,color:#1f2937,stroke-width:2px
  classDef utils fill:#fef9c3,stroke:#ca8a04,color:#713f12,stroke-width:2px

  subgraph LAYER1 ["â•â•â• CAPA DE PRESENTACIÃ“N â•â•â•"]
    direction TB
    
    subgraph UI_LAYER ["ğŸ–¥ï¸ Interfaz de Usuario"]
      direction TB
      TEMPLATES["ğŸ“„ Django Templates<br/><small>HTML/CSS/JavaScript</small>"]:::presentation
      VIEWS["ğŸ‘ï¸ Views<br/><small>Renderizado de PÃ¡ginas</small>"]:::presentation
      FORMS["ğŸ“ Forms<br/><small>ValidaciÃ³n de Entrada</small>"]:::presentation
    end
    
    subgraph API_LAYER ["ğŸ”Œ API Layer"]
      direction TB
      REST_ENDPOINTS["ğŸŒ REST Endpoints<br/><small>Django REST Framework</small>"]:::presentation
      SERIALIZERS["ğŸ“‹ Serializers<br/><small>TransformaciÃ³n de Datos</small>"]:::presentation
    end
  end

  subgraph LAYER2 ["â•â•â• CAPA DE LÃ“GICA DE NEGOCIO (Python) â•â•â•"]
    direction TB
    
    subgraph ORCHESTRATION ["ğŸ¯ OrquestaciÃ³n"]
      MAIN_CONTROLLER["âš™ï¸ Main Controller<br/><small>Coordinador Principal</small>"]:::business
      TASK_MANAGER["ğŸ“Š Task Manager<br/><small>GestiÃ³n de Tareas</small>"]:::business
      STATE_MANAGER["ğŸ’¾ State Manager<br/><small>Control de Estado</small>"]:::business
    end
    
    subgraph MODULE_ARC ["ğŸ§© MÃ“DULO ARC"]
      direction TB
      ARC_CONTROLLER["ğŸ® ARC Controller<br/><small>Controlador ARC</small>"]:::business
      ARC_LOADER["ğŸ“¥ Dataset Loader<br/><small>Carga de Puzzles</small>"]:::business
      ARC_PARSER["ğŸ” JSON Parser<br/><small>Parseo de Datos</small>"]:::business
      ARC_VALIDATOR["âœ… Validator<br/><small>ValidaciÃ³n Puzzles</small>"]:::business
      ARC_EXECUTOR["â–¶ï¸ Task Executor<br/><small>EjecuciÃ³n con Reintentos</small>"]:::business
      ARC_METRICS["ğŸ“Š Metrics Engine<br/><small>cell_accuracy, region_accuracy<br/>delta_accuracy, structural_similarity</small>"]:::business
    end
    
    subgraph MODULE_MAZE ["ğŸŒ€ MÃ“DULO MAZE"]
      direction TB
      MAZE_CONTROLLER["ğŸ® MAZE Controller<br/><small>Controlador MAZE</small>"]:::business
      MAZE_LOADER["ğŸ“¥ Dataset Loader<br/><small>Carga de Laberintos</small>"]:::business
      MAZE_PARSER["ğŸ” JSON Parser<br/><small>Parseo de Datos</small>"]:::business
      MAZE_VALIDATOR["âœ… Validator<br/><small>ValidaciÃ³n Conectividad</small>"]:::business
      MAZE_EXECUTOR["â–¶ï¸ Task Executor<br/><small>EjecuciÃ³n con Reintentos</small>"]:::business
      MAZE_METRICS["ğŸ“Š Metrics Engine<br/><small>cell_accuracy, local_consistence<br/>entropy_difference, structural_similarity</small>"]:::business
    end
    
    subgraph COMMON_SERVICES ["ğŸ”§ Servicios Comunes"]
      direction TB
      RETRY_LOGIC["ğŸ”„ Retry Handler<br/><small>LÃ³gica de Reintentos (max 3)</small>"]:::utils
      ERROR_HANDLER["âš ï¸ Error Handler<br/><small>GestiÃ³n de Errores</small>"]:::utils
      LOGGER["ğŸ“ Logger<br/><small>Sistema de Logs</small>"]:::utils
      CACHE_MANAGER["âš¡ Cache Manager<br/><small>CachÃ© en Memoria</small>"]:::utils
    end
  end

  subgraph LAYER3 ["â•â•â• CAPA DE INTEGRACIÃ“N â•â•â•"]
    direction TB
    
    subgraph LM_INTEGRATION ["ğŸ¤– IntegraciÃ³n LM Studio"]
      direction TB
      LM_CLIENT["ğŸŒ HTTP Client<br/><small>requests/httpx</small>"]:::integration
      PROMPT_BUILDER["ğŸ’¬ Prompt Builder<br/><small>Constructor Multirol</small>"]:::integration
      ROLE_AMBIENT["ğŸŒ Ambient Role<br/><small>Contexto y Restricciones</small>"]:::integration
      ROLE_ACTION["âš¡ Action Role<br/><small>Resolver y Traza</small>"]:::integration
      RESPONSE_PARSER["ğŸ“„ Response Parser<br/><small>Parseo de Respuestas</small>"]:::integration
    end
    
    subgraph BI_INTEGRATION ["ğŸ“ˆ IntegraciÃ³n Power BI"]
      direction TB
      BI_CONNECTOR["ğŸ”— BI Connector<br/><small>ConexiÃ³n Power BI</small>"]:::integration
      DATA_TRANSFORMER["ğŸ”„ Data Transformer<br/><small>TransformaciÃ³n para BI</small>"]:::integration
    end
    
    subgraph HEALTH_CHECK ["ğŸ¥ Health Check"]
      LM_HEALTH["âœ… LM Studio Health<br/><small>ValidaciÃ³n de Disponibilidad</small>"]:::integration
    end
  end

  subgraph LAYER4 ["â•â•â• CAPA DE PERSISTENCIA â•â•â•"]
    direction TB
    
    subgraph ORM_LAYER ["ğŸ—ƒï¸ ORM Layer"]
      direction TB
      DJANGO_ORM["âš™ï¸ Django ORM<br/><small>Object-Relational Mapping</small>"]:::data
      MODELS["ğŸ“ Models<br/><small>Run, Metrics, Task</small>"]:::data
      MIGRATIONS["ğŸ”„ Migrations<br/><small>GestiÃ³n de Esquema</small>"]:::data
    end
    
    subgraph DATA_ACCESS ["ğŸ’¾ Data Access Layer"]
      direction TB
      RUN_REPO["ğŸ“Š Run Repository<br/><small>CRUD Ejecuciones</small>"]:::data
      METRICS_REPO["ğŸ“ˆ Metrics Repository<br/><small>CRUD MÃ©tricas</small>"]:::data
      EXPORT_SERVICE["ğŸ“¤ Export Service<br/><small>GeneraciÃ³n CSV</small>"]:::data
    end
  end

  subgraph LAYER5 ["â•â•â• CAPA DE ALMACENAMIENTO â•â•â•"]
    direction TB
    
    subgraph DATABASES ["ğŸ—„ï¸ Bases de Datos"]
      direction LR
      DB_SQLITE[("ğŸ’½ SQLite<br/><small>Desarrollo</small>")]:::storage
      DB_POSTGRES[("ğŸ˜ PostgreSQL<br/><small>ProducciÃ³n</small>")]:::storage
    end
    
    subgraph FILES ["ğŸ“ Sistema de Archivos"]
      direction TB
      JSON_FILES["ğŸ“„ JSON Files<br/><small>/data/arc/arc.json<br/>/data/maze/maze.json</small>"]:::storage
      CSV_EXPORTS["ğŸ“Š CSV Exports<br/><small>/exports/*.csv</small>"]:::storage
      LOGS_FILES["ğŸ“ Log Files<br/><small>/logs/*.log</small>"]:::storage
    end
  end

  subgraph LAYER6 ["â•â•â• SERVICIOS EXTERNOS â•â•â•"]
    direction LR
    LM_STUDIO_SERVER["ğŸ¤– LM Studio Server<br/><small>localhost:PORT<br/>API OpenAI Compatible</small>"]:::integration
    POWERBI_DESKTOP["ğŸ“Š Power BI Desktop<br/><small>VisualizaciÃ³n y Reportes</small>"]:::integration
  end

  subgraph CONFIG_LAYER ["âš™ï¸ CONFIGURACIÃ“N"]
    direction TB
    ENV_FILE["ğŸ” .env File<br/><small>Variables de Entorno</small>"]:::config
    SETTINGS["âš™ï¸ Django Settings<br/><small>ConfiguraciÃ³n App</small>"]:::config
    REQUIREMENTS["ğŸ“¦ requirements.txt<br/><small>Dependencias Python</small>"]:::config
  end

  TEMPLATES --> VIEWS
  FORMS --> VIEWS
  VIEWS --> MAIN_CONTROLLER
  REST_ENDPOINTS --> SERIALIZERS
  SERIALIZERS --> MAIN_CONTROLLER

  MAIN_CONTROLLER --> TASK_MANAGER
  MAIN_CONTROLLER --> STATE_MANAGER
  MAIN_CONTROLLER --> LM_HEALTH
  
  TASK_MANAGER --> ARC_CONTROLLER
  TASK_MANAGER --> MAZE_CONTROLLER
  
  ARC_CONTROLLER --> ARC_LOADER
  ARC_LOADER --> ARC_PARSER
  ARC_PARSER --> ARC_VALIDATOR
  ARC_VALIDATOR --> ARC_EXECUTOR
  ARC_EXECUTOR --> RETRY_LOGIC
  ARC_EXECUTOR --> PROMPT_BUILDER
  ARC_EXECUTOR --> ARC_METRICS
  
  MAZE_CONTROLLER --> MAZE_LOADER
  MAZE_LOADER --> MAZE_PARSER
  MAZE_PARSER --> MAZE_VALIDATOR
  MAZE_VALIDATOR --> MAZE_EXECUTOR
  MAZE_EXECUTOR --> RETRY_LOGIC
  MAZE_EXECUTOR --> PROMPT_BUILDER
  MAZE_EXECUTOR --> MAZE_METRICS
  
  ARC_LOADER --> JSON_FILES
  MAZE_LOADER --> JSON_FILES
  
  PROMPT_BUILDER --> ROLE_AMBIENT
  PROMPT_BUILDER --> ROLE_ACTION
  ROLE_AMBIENT --> LM_CLIENT
  ROLE_ACTION --> LM_CLIENT
  LM_CLIENT --> LM_STUDIO_SERVER
  LM_STUDIO_SERVER --> RESPONSE_PARSER
  RESPONSE_PARSER --> ARC_EXECUTOR
  RESPONSE_PARSER --> MAZE_EXECUTOR
  
  ARC_METRICS --> RUN_REPO
  MAZE_METRICS --> METRICS_REPO
  
  RUN_REPO --> DJANGO_ORM
  METRICS_REPO --> DJANGO_ORM
  DJANGO_ORM --> MODELS
  MODELS --> MIGRATIONS
  
  DJANGO_ORM --> DB_SQLITE
  DJANGO_ORM --> DB_POSTGRES
  
  METRICS_REPO --> EXPORT_SERVICE
  EXPORT_SERVICE --> CSV_EXPORTS
  
  CSV_EXPORTS --> BI_CONNECTOR
  DB_POSTGRES --> DATA_TRANSFORMER
  DATA_TRANSFORMER --> BI_CONNECTOR
  BI_CONNECTOR --> POWERBI_DESKTOP
  
  RETRY_LOGIC --> ERROR_HANDLER
  ERROR_HANDLER --> LOGGER
  LOGGER --> LOGS_FILES
  
  ARC_LOADER --> CACHE_MANAGER
  MAZE_LOADER --> CACHE_MANAGER
  
  LM_HEALTH --> LM_CLIENT
  
  ENV_FILE -.->|config| SETTINGS
  SETTINGS -.->|config| MAIN_CONTROLLER
  SETTINGS -.->|config| DJANGO_ORM
  SETTINGS -.->|config| LM_CLIENT
  REQUIREMENTS -.->|dependencies| MAIN_CONTROLLER