{% extends "base.html" %}
{% load arc_tags %}
{% block content %}

<h2>Evaluación ARC — {{ task_id }}</h2>

<style>
.arc-grid {
  border-collapse: collapse;
  margin: 0.5rem 0 1.5rem 0;
}
.arc-grid td {
  width: 22px;
  height: 22px;
  padding: 0;
  border: 1px solid #2223;
}
.arc-legend { display: inline-block; margin-left: .5rem; }
.arc-cell { display: inline-block; width: 1rem; height: 1rem; border: 1px solid #0002; vertical-align: middle; }
</style>

{% if error %}
<article class="contrast">
  <h3>Error</h3>
  <p>{{ error }}</p>
  <p><a href="{% url 'detail' task_id %}">&larr; Volver</a></p>
</article>
{% else %}

<p>
  <b>Split:</b> {{ split }} |
  <b>Par train evaluado (i):</b> {{ i }} |
  <b>Modelo:</b> <code>{{ model_id }}</code> |
  <b>Latencia:</b> {{ latency_s }} s
</p>

{% if metrics %}
<article>
  <h4>Métricas de comparación</h4>
  <ul>
    <li><b>Cell Accuracy:</b> {{ metrics.cell_accuracy_pct|floatformat:2 }} % ({{ metrics.correct }}/{{ metrics.total }})</li>
    <li><b>Dimensiones Esperado:</b> {{ metrics.expected_shape }}</li>
    <li><b>Dimensiones Predicho:</b> {{ metrics.pred_shape }}</li>
  </ul>
</article>
{% endif %}

<section style="margin-top: 1.5rem;">
  <h3>Métricas extendidas</h3>
  <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem;">
    {% for key, val in metrics.items %}
      {% if key not in "exact_match,correct,total,expected_shape,pred_shape" %}
        <div style="background:#1f2937; padding:.75rem; border-radius:8px; color:#e5e7eb;">
          <b>{{ key|title }}</b><br>
          <progress value="{{ val }}" max="1" style="width:100%; height:8px;"></progress>
          <span style="font-size:.9rem;">{{ val|floatformat:3 }}</span>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</section>

<!-- Lo que se evaluó: input objetivo -->
<article>
  <h3>Input objetivo (train[{{ i }}].input)</h3>
  <div style="overflow-x:auto; max-width:100%;">
    <table class="arc-grid">
      <tbody>
        {% for row in target_input %}
        <tr>
          {% for v in row %}
          <td style="background: {{ v|cell_color }}" title="{{ v }}"></td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</article>

<!-- Resultado -->
<article class="{% if exact %}success{% else %}contrast{% endif %}">
  <h3>Resultado: {{ status }}</h3>
  {% if not predicted %}
    <p>No se pudo parsear una matriz válida de la respuesta del modelo.</p>
  {% endif %}
</article>

<div style="display:flex; gap:2rem; align-items:flex-start; flex-wrap: wrap;">
  <div>
    <h4>Esperado</h4>
    <table class="arc-grid">
      <tbody>
        {% for row in expected %}
        <tr>
          {% for v in row %}
          <td style="background: {{ v|cell_color }}" title="{{ v }}"></td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div>
    <h4>Predicho</h4>
    {% if predicted %}
    <table class="arc-grid">
      <tbody>
        {% for row in predicted %}
        <tr>
          {% for v in row %}
          <td style="background: {{ v|cell_color }}" title="{{ v }}"></td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <p>(sin matriz válida)</p>
    {% endif %}
  </div>
</div>

<!-- Ejemplos usados como contexto -->
<details style="margin-top:1rem;">
  <summary><b>Ver ejemplos usados ({{ examples|length }})</b></summary>
  <div style="display:flex; flex-direction:column; gap:1.5rem; margin-top: .75rem;">
    {% for ex in examples %}
    <div style="display:flex; gap:1.5rem; flex-wrap:wrap;">
      <div>
        <h5>Ejemplo {{ forloop.counter }} — Input</h5>
        <div style="overflow-x:auto; max-width:100%;">
          <table class="arc-grid">
            <tbody>
              {% for row in ex.input %}
              <tr>
                {% for v in row %}
                <td style="background: {{ v|cell_color }}" title="{{ v }}"></td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div>
        <h5>Ejemplo {{ forloop.counter }} — Output</h5>
        <div style="overflow-x:auto; max-width:100%;">
          <table class="arc-grid">
            <tbody>
              {% for row in ex.output %}
              <tr>
                {% for v in row %}
                <td style="background: {{ v|cell_color }}" title="{{ v }}"></td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% empty %}
    <p>(No hubo ejemplos adicionales: la tarea solo tiene 1 par train.)</p>
    {% endfor %}
  </div>
</details>

<details>
  <summary>Ver respuesta cruda del modelo</summary>
  <pre style="white-space: pre-wrap">{{ raw_content }}</pre>
</details>

<p>
  <a href="{% url 'arc_detail' task_id %}">&larr; Volver a la tarea</a>
</p>

{% endif %}
{% endblock %}